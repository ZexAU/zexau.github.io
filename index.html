<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center justify-center min-h-screen">

    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-2xl w-full">
        <!-- Game Title -->
        <h1 class="text-4xl font-extrabold text-white text-center mb-6">Game</h1>

        <!-- Character and Enemy Status -->
        <div class="flex flex-col md:flex-row justify-between items-stretch gap-4 mb-6">
            <!-- Player Status -->
            <div id="player-status" class="bg-gray-700 p-4 rounded-lg flex-1 shadow-inner">
                <h2 class="text-xl font-bold text-green-400 mb-2">You</h2>
                <p id="player-level">Level: 1 (0/10 XP)</p>
                <p id="player-health">HP: 20/20</p>
                <p id="player-mana">Mana: 10/10</p>
                <p id="player-attack-range">
                    Attack: 1-5 (90%)
                </p>
                <!-- Player Stats with Skill Point Buttons -->
                <div class="flex items-center gap-2">
                    <p id="player-str" title="+1 to Min Dmg, +1 to Max Dmg, +1 HP">STR: 0</p>
                    <button id="add-str" class="hidden text-white bg-blue-500 hover:bg-blue-600 rounded-full h-5 w-5 text-xs font-bold transition duration-200 leading-none">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <p id="player-dex" title="+2% to Accuracy">DEX: 0</p>
                    <button id="add-dex" class="hidden text-white bg-blue-500 hover:bg-blue-600 rounded-full h-5 w-5 text-xs font-bold transition duration-200 leading-none">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <p id="player-rec" title="+3 HP">REC: 0</p>
                    <button id="add-rec" class="hidden text-white bg-blue-500 hover:bg-blue-600 rounded-full h-5 w-5 text-xs font-bold transition duration-200 leading-none">+</button>
                </div>
                <div class="flex items-center gap-2">
                    <p id="player-int" title="+2 Mana, +1 Heal per Spell Power">INT: 0</p>
                    <button id="add-int" class="hidden text-white bg-blue-500 hover:bg-blue-600 rounded-full h-5 w-5 text-xs font-bold transition duration-200 leading-none">+</button>
                </div>
                <!-- New line for Damage Reduction -->
                <p id="player-dr" class="text-sm mt-2">DR: 0</p>
                <!-- Player Item Slots -->
                <div class="mt-4 border-t border-gray-600 pt-4">
                    <h3 class="text-lg font-semibold mb-2">Equipment</h3>
                    <p id="helmet-slot" class="text-sm">Helmet: Empty</p>
                    <p id="chest-slot" class="text-sm">Chest: Empty</p>
                    <p id="boots-slot" class="text-sm">Boots: Empty</p>
                    <p id="weapon-slot" class="text-sm">Weapon: Empty</p>
                    <p id="shield-slot" class="text-sm">Shield: Empty</p>
                </div>
            </div>
            <!-- Enemy Status -->
            <div id="enemy-status" class="bg-gray-700 p-4 rounded-lg flex-1 shadow-inner">
                <h2 class="text-xl font-bold text-red-400 mb-2">Enemy</h2>
                <p id="enemy-level">Level: 1</p>
                <p id="enemy-health">HP: 20/20</p>
                <p id="enemy-mana">Mana: 10/10</p>
                <p id="enemy-attack-range">
                    Attack: 1-4 (90%)
                </p>
                <p id="enemy-str" title="+1 to Min Dmg, +1 to Max Dmg, +1 HP">STR: 0</p>
                <p id="enemy-dex" title="+2% to Accuracy">DEX: 0</p>
                <p id="enemy-rec" title="+3 HP">REC: 0</p>
                <p id="enemy-int" title="No effect yet">INT: 0</p>
                <!-- New line for Damage Reduction -->
                <p id="enemy-dr" class="text-sm mt-2">DR: 0</p>
            </div>
        </div>

        <!-- Game Log -->
        <div id="game-log-container">
            <div id="game-log" class="bg-gray-900 h-64 p-4 rounded-lg overflow-y-auto mb-4 text-sm text-gray-300">
                <!-- This is now empty, message is generated by JS -->
            </div>
            <div id="victory-buttons" class="hidden">
                <button id="next-enemy-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md w-full">
                    Next Enemy
                </button>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div id="action-buttons" class="grid grid-cols-2 gap-4">
            <button id="attack-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Attack
            </button>
            <button id="spells-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Spells
            </button>
        </div>

        <!-- Spells Menu -->
        <div id="spells-menu" class="hidden">
            <div id="spell-list" class="flex flex-col gap-2">
                <!-- Spell buttons will be dynamically added here -->
            </div>
            <button id="back-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md w-full mt-4">
                Back
            </button>
        </div>

        <!-- Item Found Modal -->
        <div id="item-found-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 p-8 rounded-lg text-center shadow-2xl w-full max-w-sm">
                <h2 class="text-3xl font-bold mb-4">Item Found!</h2>
                <div class="flex justify-between items-start gap-4 text-left">
                    <!-- Equipped Item -->
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-400 mb-2">Equipped Item</h3>
                        <p id="equipped-item-name" class="text-sm text-white"></p>
                        <div id="equipped-item-stats" class="text-xs text-gray-300"></div>
                    </div>
                    <!-- New Item -->
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">New Item</h3>
                        <p id="item-name" class="text-sm text-white"></p>
                        <div id="item-stats" class="text-xs text-gray-300"></div>
                    </div>
                </div>
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button id="equip-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                        Equip
                    </button>
                    <button id="discard-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                        Discard
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Permanent Reset Button and new Add Item button -->
        <div class="mt-4 flex gap-4">
            <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md w-full">
                Reset Game
            </button>
            <button id="add-item-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md w-full">
                Add Item
            </button>
        </div>
    </div>

    <!-- Game over overlay (for player loss only) -->
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg text-center shadow-2xl">
            <h2 id="game-over-text" class="text-3xl font-bold mb-4">You were defeated!</h2>
            <button id="restart-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                Restart Game
            </button>
        </div>
    </div>

    <script>
        // ===================================
        // Global Game State and Definitions
        // ===================================
        let player = {};
        let enemy = {};
        // The enemy level is now a separate variable that increments with each new battle.
        let currentEnemyLevel = 1;

        // Define base values globally
        const baseMinDamage = 2;
        const baseMaxDamage = 5;
        const baseHealth = 20;
        const baseMana = 10;
        const baseHealAmount = 5;

        // Item rarities and colors
        const rarities = {
            'Normal': 'text-white',
            'Magic': 'text-blue-400',
            'Rare': 'text-yellow-400',
            'Epic': 'text-purple-400'
        };

        const statAbbreviations = {
            strength: 'STR',
            dexterity: 'DEX',
            recovery: 'REC',
            intelligence: 'INT',
            damage_reduction: 'DR', // Added new abbreviation for damage reduction
            mana_regen: 'M_REG',
            hp_regen: 'H_REG',
            health: 'HP', // New abbreviation for health
        };

        // Item stats by rarity (number of mods)
        const itemStats = {
            'Normal': { mods: { min: 0, max: 0 } },
            'Magic': { mods: { min: 1, max: 2 } },
            'Rare': { mods: { min: 3, max: 4 } },
            'Epic': { mods: { min: 5, max: 6 } }
        };

        // A new, explicit data structure for stat tier ranges
        const statTierRanges = {
            // Tier 10 ranges (as requested)
            strength: {
                10: { min: 1, max: 3 }
            },
            dexterity: {
                10: { min: 1, max: 3 }
            },
            recovery: {
                10: { min: 1, max: 3 }
            },
            intelligence: {
                10: { min: 1, max: 3 }
            },
            mana_regen: {
                10: { min: 1, max: 3 }
            },
            hp_regen: {
                10: { min: 1, max: 3 }
            },
            health: {
                10: { min: 2, max: 5 }
            },
            damage_reduction: {
                10: { min: 1, max: 2 }
            },
            // Add other tiers (9, 8, etc.) here as needed
        };


        // Item Definitions (expanded to include all slots)
        const helmetItems = [
            "Leather Helmet,Evasion,dexterity:1",
            "Iron Helm,Armour,strength:1"
        ];
        const chestItems = [
            "Leather Chestpiece,Evasion,dexterity:1",
            "Iron Breastplate,Armour,strength:1"
        ];
        const bootsItems = [
            "Leather Boots,Evasion,dexterity:1",
            "Iron Greaves,Armour,strength:1"
        ];
        const weaponItems = [
            "Rusty Sword,Physical,strength:2",
            "Old Staff,Magic,intelligence:2"
        ];
        const shieldItems = [
            // The shield now provides Damage Reduction directly, instead of Recovery
            "Wooden Shield,Defence,damage_reduction:2"
        ];
        
        // A master list of all item types by slot
        const itemDefinitions = {
            helmet: helmetItems,
            chest: chestItems,
            boots: bootsItems,
            weapon: weaponItems,
            shield: shieldItems,
        };

        // Item parsing and creation functions
        function createItem(itemString, rarity, level, slot) {
            const parts = itemString.split(',');
            const name = parts[0];
            const type = parts[1];
            
            const implicitStats = {};
            const explicitStats = {};
            
            const tier = 11 - Math.ceil(level / 5);
            
            // Get the correct stat range based on the stat name and tier
            const getStatRange = (statName, tier) => {
                const statRanges = statTierRanges[statName];
                if (statRanges && statRanges[tier]) {
                    return statRanges[tier];
                }
                return { min: 1, max: 1 }; // Fallback for undefined tiers or stats
            };
            
            // Parse implicit stats and scale with level
            if (parts.length > 2) {
                const implicitParts = parts[2].split(':');
                const implicitStatName = implicitParts[0];
                let baseImplicitValue = parseInt(implicitParts[1]);

                // Special handling for implicit stats like health on items
                if (implicitStatName === 'health') {
                    implicitStats[implicitStatName] = baseImplicitValue;
                } else {
                    const levelTier = Math.ceil(level / 5);
                    if (levelTier === 1) baseImplicitValue = 1;
                    else if (levelTier === 2) baseImplicitValue = 3;
                    else if (levelTier === 3) baseImplicitValue = 5;
                    else baseImplicitValue = 7;
                    implicitStats[implicitStatName] = baseImplicitValue;
                }
            }
            
            // Roll for explicit stats
            const modsToAllocate = itemStats[rarity].mods.min + Math.floor(Math.random() * (itemStats[rarity].mods.max - itemStats[rarity].mods.min + 1));
            let availableStats = ['strength', 'dexterity', 'recovery', 'intelligence', 'damage_reduction', 'mana_regen', 'hp_regen', 'health'];
            
            for (let i = 0; i < modsToAllocate; i++) {
                if (availableStats.length === 0) break;
                const randomStatIndex = Math.floor(Math.random() * availableStats.length);
                const randomStat = availableStats[randomStatIndex];
                availableStats.splice(randomStatIndex, 1);
                
                // Use the stat-specific tier ranges
                const statRangeForRoll = getStatRange(randomStat, tier);
                const statValue = statRangeForRoll.min + Math.floor(Math.random() * (statRangeForRoll.max - statRangeForRoll.min + 1));
                
                explicitStats[randomStat] = statValue;
            }

            return {
                name: name,
                rarity: rarity,
                type: type,
                slot: slot,
                implicitStats: implicitStats,
                explicitStats: explicitStats,
                tier: tier
            };
        }

        function rollRarity(level) {
            const roll = Math.floor(Math.random() * 100);
            if (roll > 90) return 'Epic';
            if (roll > 70) return 'Rare';
            if (roll > 40) return 'Magic';
            return 'Normal';
        }
        
        // This function now randomly selects a slot and an item from the master list
        function getRandomItem() {
            const slots = Object.keys(itemDefinitions);
            const randomSlot = slots[Math.floor(Math.random() * slots.length)];
            const itemArray = itemDefinitions[randomSlot];
            const randomItemString = itemArray[Math.floor(Math.random() * itemArray.length)];
            const rarity = rollRarity(enemy.level);
            return createItem(randomItemString, rarity, enemy.level, randomSlot);
        }

        const spells = {
            'Heal': {
                name: 'Heal',
                description: 'Heals you for a small amount.',
                cost: 4,
                effect: function(target) {
                    const healAmount = baseHealAmount + target.intelligence;
                    target.health += healAmount;
                    if (target.health > target.maxHealth) {
                        target.health = target.maxHealth;
                    }
                    const name = target === player ? 'Hero' : target.name;
                    logMessage(`<span class="text-green-500 font-bold">${name}</span> casts Heal, recovering <span class="text-green-500 font-bold">${healAmount} HP.</span>`);
                },
                scaling: '+1 heal per Spell Power'
            }
        };

        // ===================================
        // DOM Elements
        // ===================================
        const playerHealthEl = document.getElementById('player-health');
        const playerManaEl = document.getElementById('player-mana');
        const playerAttackEl = document.getElementById('player-attack-range');
        const playerStrEl = document.getElementById('player-str');
        const playerDexEl = document.getElementById('player-dex');
        const playerRecEl = document.getElementById('player-rec');
        const playerIntEl = document.getElementById('player-int');
        const playerLevelEl = document.getElementById('player-level');
        const playerDrEl = document.getElementById('player-dr'); // Added new DR element
        const addStrButton = document.getElementById('add-str');
        const addDexButton = document.getElementById('add-dex');
        const addRecButton = document.getElementById('add-rec');
        const addIntButton = document.getElementById('add-int');
        const enemyHealthEl = document.getElementById('enemy-health');
        const enemyManaEl = document.getElementById('enemy-mana');
        const enemyAttackEl = document.getElementById('enemy-attack-range');
        const enemyStrEl = document.getElementById('enemy-str');
        const enemyDexEl = document.getElementById('enemy-dex');
        const enemyRecEl = document.getElementById('enemy-rec');
        const enemyIntEl = document.getElementById('enemy-int');
        const enemyLevelEl = document.getElementById('enemy-level');
        const enemyDrEl = document.getElementById('enemy-dr'); // Added new DR element
        const gameLogEl = document.getElementById('game-log');
        const attackButton = document.getElementById('attack-button');
        const spellsButton = document.getElementById('spells-button');
        const resetButton = document.getElementById('reset-button');
        const addItemButton = document.getElementById('add-item-button');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverText = document.getElementById('game-over-text');
        const victoryButtonsContainer = document.getElementById('victory-buttons');
        const nextEnemyButton = document.getElementById('next-enemy-button');
        const actionButtonsContainer = document.getElementById('action-buttons');
        const spellsMenuContainer = document.getElementById('spells-menu');
        const spellListEl = document.getElementById('spell-list');
        const backButton = document.getElementById('back-button');
        const restartButton = document.getElementById('restart-button');
        const helmetSlotEl = document.getElementById('helmet-slot');
        const chestSlotEl = document.getElementById('chest-slot');
        const bootsSlotEl = document.getElementById('boots-slot');
        const weaponSlotEl = document.getElementById('weapon-slot');
        const shieldSlotEl = document.getElementById('shield-slot');
        const itemFoundModal = document.getElementById('item-found-modal');
        const itemNameEl = document.getElementById('item-name');
        const itemStatsEl = document.getElementById('item-stats');
        const equippedItemNameEl = document.getElementById('equipped-item-name');
        const equippedItemStatsEl = document.getElementById('equipped-item-stats');
        const equipButton = document.getElementById('equip-button');
        const discardButton = document.getElementById('discard-button');
        
        // ===================================
        // Core Game Functions
        // ===================================
        function logMessage(message) {
            const p = document.createElement('p');
            p.innerHTML = message;
            gameLogEl.appendChild(p);
            gameLogEl.scrollTop = gameLogEl.scrollHeight;
        }

        function checkLevelUp() {
            if (player.xp >= player.xpToNextLevel) {
                player.level++;
                player.xp -= player.xpToNextLevel;
                player.skillPoints += 2;
                player.xpToNextLevel = player.level * 10;
                logMessage(`<span class="text-green-500 font-bold">Hero</span> has reached Level ${player.level}! You gained 2 skill points!`);
                
                // Recalculate max health and mana after level up
                player.maxHealth = baseHealth + (player.strength * 1) + (player.recovery * 3) + player.bonusHealth;
                player.health = player.maxHealth;
                player.maxMana = baseMana + (player.intelligence * 2);
                player.mana = player.maxMana;

                updateUI();
            }
        }

        // This function now takes the enemy's level as an argument
        function createEnemy(enemyLevel) {
            const enemyType = Math.random() < 0.5 ? 'Warrior' : 'Mage';
            const baseHP = enemyType === 'Mage' ? 16 : baseHealth;
            const enemyBaseMinDamage = enemyType === 'Mage' ? 1 : baseMinDamage;
            const enemyBaseMaxDamage = enemyType === 'Mage' ? 4 : baseMaxDamage;

            let enemyStrength = 0;
            let enemyDexterity = 0;
            let enemyRecovery = 0;
            let enemyIntelligence = 0;
            let enemyDamageReduction = 0; // New stat for the enemy
            let enemyMana = baseMana;
            let enemyMaxMana = baseMana;

            const skillPointsToAllocate = (enemyLevel > 1) ? (enemyLevel - 1) * 2 : 0;
            for (let i = 0; i < skillPointsToAllocate; i++) {
                let randomStat;
                if (enemyType === 'Mage') {
                    randomStat = Math.floor(Math.random() * 3);
                    switch (randomStat) {
                        case 0: enemyDexterity++; break;
                        case 1: enemyRecovery++; break;
                        case 2: enemyIntelligence++; break;
                    }
                } else {
                    randomStat = Math.floor(Math.random() * 3);
                    switch (randomStat) {
                        case 0: enemyStrength++; break;
                        case 1: enemyDexterity++; break;
                        case 2: enemyRecovery++; break;
                    }
                }
            }

            enemyMana = baseMana + (enemyIntelligence * 2);
            enemyMaxMana = enemyMana;
            
            const newEnemy = {
                name: `Skeleton ${enemyType}`,
                strength: enemyStrength,
                dexterity: enemyDexterity,
                recovery: enemyRecovery,
                intelligence: enemyIntelligence,
                damageReduction: enemyDamageReduction, // Initialized new stat
                level: enemyLevel,
                health: baseHP + (enemyStrength * 1) + (enemyRecovery * 3),
                maxHealth: baseHP + (enemyStrength * 1) + (enemyRecovery * 3),
                mana: enemyMana,
                maxMana: enemyMaxMana,
                baseMinDamage: enemyBaseMinDamage,
                baseMaxDamage: enemyBaseMaxDamage,
            };
            return newEnemy;
        }

        function performAttack(attacker, defender) {
            const accuracyChance = 90 + (attacker.dexterity - defender.dexterity) * 2 + (attacker.level - defender.level);
            const roll = Math.floor(Math.random() * 100) + 1;

            if (roll <= accuracyChance) {
                const minDamage = attacker.baseMinDamage + attacker.strength;
                const maxDamage = attacker.baseMaxDamage + attacker.strength;
                let damage = Math.floor(Math.random() * (maxDamage - minDamage + 1)) + minDamage;
                
                // Damage is now reduced by the new damageReduction stat
                damage = Math.max(0, damage - defender.damageReduction);

                defender.health -= damage;
                if (defender.health < 0) defender.health = 0;
                
                const attackerName = attacker === player ? 'Hero' : attacker.name;
                const defenderName = defender === player ? 'Hero' : defender.name;
                const attackerColor = attacker === player ? 'text-green-500' : 'text-red-400';
                const defenderColor = defender === player ? 'text-green-500' : 'text-red-400';
                
                logMessage(`<span class="${attackerColor} font-bold">${attackerName}</span> attacks <span class="${defenderColor} font-bold">${defenderName}</span> for <span class="text-orange-400 font-bold">${damage}</span> damage!`);
            } else {
                const attackerName = attacker === player ? 'Hero' : attacker.name;
                const attackerColor = attacker === player ? 'text-green-500' : 'text-red-400';
                logMessage(`<span class="${attackerColor} font-bold">${attackerName}</span>'s attack missed!`);
            }
        }

        function castSpell(caster, spell, target) {
            if (caster.mana >= spell.cost) {
                caster.mana -= spell.cost;
                spell.effect(target);
                return true;
            }
            return false;
        }

        function handleVictory() {
            logMessage(`<span class="text-green-500 font-bold">Hero</span> has defeated the <span class="text-red-400 font-bold">Enemy</span>! You gained 10 XP.`);
            player.xp += 10;
            checkLevelUp();
            player.isTurn = false;
            actionButtonsContainer.classList.add('hidden');
            victoryButtonsContainer.classList.remove('hidden');
            updateUI();
            
            // Item generation is now based on the enemy's level
            const droppedItem = getRandomItem();
            if (droppedItem) {
                logMessage(`You found a new item!`);
                showItemFoundModal(droppedItem);
            }
        }
        
        function equipItem(item) {
            const slot = item.slot;
            const oldItem = player.equipment[slot];
            
            if (oldItem) {
                // Remove all bonuses from the old item
                player.strength -= oldItem.implicitStats.strength || 0;
                player.dexterity -= oldItem.implicitStats.dexterity || 0;
                player.recovery -= oldItem.implicitStats.recovery || 0;
                player.intelligence -= oldItem.implicitStats.intelligence || 0;
                player.damageReduction -= oldItem.implicitStats.damage_reduction || 0; 
                player.bonusHealth -= oldItem.implicitStats.health || 0; 
                
                player.strength -= oldItem.explicitStats.strength || 0;
                player.dexterity -= oldItem.explicitStats.dexterity || 0;
                player.recovery -= oldItem.explicitStats.recovery || 0;
                player.intelligence -= oldItem.explicitStats.intelligence || 0;
                player.damageReduction -= oldItem.explicitStats.damage_reduction || 0; 
                player.bonusHealth -= oldItem.explicitStats.health || 0;
            }
            
            // Add all bonuses from the new item
            player.equipment[slot] = item;
            player.strength += item.implicitStats.strength || 0;
            player.dexterity += item.implicitStats.dexterity || 0;
            player.recovery += item.implicitStats.recovery || 0;
            player.intelligence += item.implicitStats.intelligence || 0;
            player.damageReduction += item.implicitStats.damage_reduction || 0; 
            player.bonusHealth += item.implicitStats.health || 0; 
            
            player.strength += item.explicitStats.strength || 0;
            player.dexterity += item.explicitStats.dexterity || 0;
            player.recovery += item.explicitStats.recovery || 0;
            player.intelligence += item.explicitStats.intelligence || 0;
            player.damageReduction += item.explicitStats.damage_reduction || 0; 
            player.bonusHealth += item.explicitStats.health || 0; 
            
            // Recalculate max health and mana
            player.maxHealth = baseHealth + (player.strength * 1) + (player.recovery * 3) + player.bonusHealth;
            // Restore player health to the new max health if it's currently higher than the previous max
            player.health = Math.min(player.health, player.maxHealth);
            player.maxMana = baseMana + (player.intelligence * 2);
            player.mana = player.maxMana;
            
            logMessage(`You equipped the <span class="${rarities[item.rarity]}">${item.name}</span>!`);
            updateUI();
        }

        function handleDefeat() {
            logMessage(`<span class="text-green-500 font-bold">Hero</span> was defeated! The <span class="text-red-400 font-bold">Enemy</span> has triumphed.`);
            gameOverModal.classList.remove('hidden');
            player.isTurn = false;
            updateUI();
        }

        function checkGameState() {
            if (player.health <= 0) {
                handleDefeat();
                return true;
            } else if (enemy.health <= 0) {
                handleVictory();
                return true;
            }
            return false;
        }

        function enemyTurn() {
            if (checkGameState()) return;
            
            player.isTurn = false;
            updateUI();

            setTimeout(() => {
                if (enemy.name.includes('Mage') && enemy.health < enemy.maxHealth * 0.5 && enemy.mana >= spells['Heal'].cost) {
                    const healRoll = Math.floor(Math.random() * 4);
                    if (healRoll === 0) {
                        castSpell(enemy, spells['Heal'], enemy);
                    } else {
                        performAttack(enemy, player);
                    }
                } else {
                    performAttack(enemy, player);
                }
                
                updateUI();

                if (!checkGameState()) {
                    player.isTurn = true;
                    updateUI();
                }
            }, 1000);
        }

        // ===================================
        // UI Functions
        // ===================================
        function renderSpellsMenu() {
            spellListEl.innerHTML = '';
            Object.values(player.spells).forEach(spell => {
                const spellButton = document.createElement('button');
                spellButton.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-3', 'px-6', 'rounded-lg', 'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:scale-105', 'shadow-md', 'w-full', 'text-left');
                
                const healAmount = baseHealAmount + player.intelligence;
                spellButton.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-lg">${spell.name}</p>
                            <p class="text-sm text-gray-200">Heals: ${healAmount} HP</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-200">Cost: ${spell.cost} Mana</p>
                            <p class="text-xs text-gray-200">${spell.scaling}</p>
                        </div>
                    </div>
                `;

                if (player.mana < spell.cost || !player.isTurn) {
                    spellButton.disabled = true;
                    spellButton.classList.add('opacity-50', 'cursor-not-allowed');
                }

                spellButton.addEventListener('click', () => {
                    if (castSpell(player, spell, player)) {
                        updateUI();
                        if (!checkGameState()) {
                            enemyTurn();
                        }
                    } else {
                        logMessage("You don't have enough mana to cast that spell!");
                    }
                    hideSpellsMenu();
                });
                spellListEl.appendChild(spellButton);
            });
        }

        function showSpellsMenu() {
            actionButtonsContainer.classList.add('hidden');
            spellsMenuContainer.classList.remove('hidden');
            renderSpellsMenu();
        }

        function hideSpellsMenu() {
            spellsMenuContainer.classList.add('hidden');
            actionButtonsContainer.classList.remove('hidden');
        }

        // Updated function to show a comparison between the equipped item and the new item
        function showItemFoundModal(item) {
            const equippedItem = player.equipment[item.slot];

            // Update equipped item display
            if (equippedItem) {
                equippedItemNameEl.textContent = equippedItem.name;
                equippedItemNameEl.className = `text-sm font-bold ${rarities[equippedItem.rarity]}`;
                let equippedStatsHtml = '';
                const equippedImplicitMods = Object.keys(equippedItem.implicitStats).length;
                const equippedExplicitMods = Object.keys(equippedItem.explicitStats).length;
                if (equippedImplicitMods > 0) {
                    equippedStatsHtml += `<p class="font-bold">Implicit Modifiers:</p>`;
                    for (const stat in equippedItem.implicitStats) {
                        equippedStatsHtml += `<p>${statAbbreviations[stat]} +${equippedItem.implicitStats[stat]}</p>`;
                    }
                }
                if (equippedExplicitMods > 0) {
                    equippedStatsHtml += `<p class="font-bold mt-2">Explicit Modifiers:</p>`;
                    for (const stat in equippedItem.explicitStats) {
                         const statRange = statTierRanges[stat] ? statTierRanges[stat][equippedItem.tier] : null;
                        const rangeDisplay = statRange ? `(T${equippedItem.tier} ${statRange.min}-${statRange.max})` : '';
                        equippedStatsHtml += `<p>${statAbbreviations[stat]} +${equippedItem.explicitStats[stat]} ${rangeDisplay}</p>`;
                    }
                }
                equippedItemStatsEl.innerHTML = equippedStatsHtml;

            } else {
                equippedItemNameEl.textContent = 'None';
                equippedItemNameEl.className = 'text-sm font-bold text-gray-400';
                equippedItemStatsEl.innerHTML = '';
            }

            // Update new item display
            itemNameEl.textContent = item.name;
            itemNameEl.className = `text-sm font-bold ${rarities[item.rarity]}`;
            
            let statsHtml = '';
            const implicitMods = Object.keys(item.implicitStats).length;
            const explicitMods = Object.keys(item.explicitStats).length;
            
            // Get the correct stat range based on the stat name and tier
            const getStatRange = (statName, tier) => {
                const statRanges = statTierRanges[statName];
                if (statRanges && statRanges[tier]) {
                    return statRanges[tier];
                }
                return { min: 1, max: 1 }; // Fallback for undefined tiers or stats
            };

            if (implicitMods > 0) {
                statsHtml += `<p class="font-bold">Implicit Modifiers:</p>`;
                for (const stat in item.implicitStats) {
                    statsHtml += `<p>${statAbbreviations[stat]} +${item.implicitStats[stat]}</p>`;
                }
            }
            if (explicitMods > 0) {
                statsHtml += `<p class="font-bold mt-2">Explicit Modifiers:</p>`;
                for (const stat in item.explicitStats) {
                    // Display the tier and stat range for each individual explicit modifier
                    const statRange = getStatRange(stat, item.tier);
                    const rangeDisplay = statRange ? `(T${item.tier} ${statRange.min}-${statRange.max})` : '';
                    statsHtml += `<p>${statAbbreviations[stat]} +${item.explicitStats[stat]} ${rangeDisplay}</p>`;
                }
            }
            itemStatsEl.innerHTML = statsHtml;
            
            equipButton.onclick = () => {
                equipItem(item);
                itemFoundModal.classList.add('hidden');
                victoryButtonsContainer.classList.remove('hidden');
            };
            
            discardButton.onclick = () => {
                logMessage(`You discarded the <span class="${rarities[item.rarity]}">${item.name}</span>.`);
                itemFoundModal.classList.add('hidden');
                victoryButtonsContainer.classList.remove('hidden');
                updateUI();
            };
            
            itemFoundModal.classList.remove('hidden');
        }

        function updateUI() {
            playerHealthEl.textContent = `HP: ${player.health}/${player.maxHealth}`;
            playerManaEl.textContent = `Mana: ${player.mana}/${player.maxMana}`;
            playerStrEl.textContent = `STR: ${player.strength}`;
            playerDexEl.textContent = `DEX: ${player.dexterity}`;
            playerRecEl.textContent = `REC: ${player.recovery}`;
            playerIntEl.textContent = `INT: ${player.intelligence}`;
            // Added new display for Damage Reduction
            playerDrEl.textContent = `DR: ${player.damageReduction}`;
            playerLevelEl.textContent = `Level: ${player.level} (${player.xp}/${player.xpToNextLevel} XP)`;
            
            if (player.skillPoints > 0) {
                addStrButton.classList.remove('hidden');
                addDexButton.classList.remove('hidden');
                addRecButton.classList.remove('hidden');
                addIntButton.classList.remove('hidden');
            } else {
                addStrButton.classList.add('hidden');
                addDexButton.classList.add('hidden');
                addRecButton.classList.add('hidden');
                addIntButton.classList.add('hidden');
            }

            const playerMinDamage = player.baseMinDamage + player.strength;
            const playerMaxDamage = player.baseMaxDamage + player.strength;
            const playerAccuracy = 90 + (player.dexterity - enemy.dexterity) * 2 + (player.level - enemy.level);
            playerAttackEl.textContent = `Attack: ${playerMinDamage}-${playerMaxDamage} (${playerAccuracy}%)`;

            document.querySelector('#enemy-status h2').textContent = enemy.name;
            enemyHealthEl.textContent = `HP: ${enemy.health}/${enemy.maxHealth}`;
            enemyManaEl.textContent = `Mana: ${enemy.mana}/${enemy.maxMana}`;
            enemyStrEl.textContent = `STR: ${enemy.strength}`;
            enemyDexEl.textContent = `DEX: ${enemy.dexterity}`;
            enemyRecEl.textContent = `REC: ${enemy.recovery}`;
            enemyIntEl.textContent = `INT: ${enemy.intelligence}`;
            // Added new display for Enemy Damage Reduction
            enemyDrEl.textContent = `DR: ${enemy.damageReduction}`;
            enemyLevelEl.textContent = `Level: ${enemy.level}`;
            
            const enemyMinDamage = enemy.baseMinDamage + enemy.strength;
            const enemyMaxDamage = enemy.baseMaxDamage + enemy.strength;
            const enemyAccuracy = 90 + (enemy.dexterity - player.dexterity) * 2 + (enemy.level - player.level);
            enemyAttackEl.textContent = `Attack: ${enemyMinDamage}-${enemyMaxDamage} (${enemyAccuracy}%)`;

            attackButton.disabled = !player.isTurn;
            spellsButton.disabled = !player.isTurn;

            if (player.health < player.maxHealth / 4) {
                playerHealthEl.classList.remove('text-green-400', 'text-yellow-400');
                playerHealthEl.classList.add('text-red-400');
            } else if (player.health < player.maxHealth / 2) {
                playerHealthEl.classList.remove('text-red-400', 'text-green-400');
                playerHealthEl.classList.add('text-yellow-400');
            } else {
                playerHealthEl.classList.remove('text-red-400', 'text-yellow-400');
                playerHealthEl.classList.add('text-green-400');
            }

            if (player.mana < player.maxMana / 4) {
                playerManaEl.classList.remove('text-blue-400', 'text-yellow-400');
                playerManaEl.classList.add('text-red-400');
            } else if (player.mana < player.maxMana / 2) {
                playerManaEl.classList.remove('text-red-400', 'text-blue-400');
                playerManaEl.classList.add('text-yellow-400');
            } else {
                playerManaEl.classList.remove('text-red-400', 'text-yellow-400');
                playerManaEl.classList.add('text-blue-400');
            }

            if (enemy.health < enemy.maxHealth / 4) {
                enemyHealthEl.classList.remove('text-green-400', 'text-yellow-400');
                enemyHealthEl.classList.add('text-red-400');
            } else if (enemy.health < enemy.maxHealth / 2) {
                enemyHealthEl.classList.remove('text-red-400', 'text-green-400');
                enemyHealthEl.classList.add('text-yellow-400');
            } else {
                enemyHealthEl.classList.remove('text-red-400', 'text-yellow-400');
                enemyHealthEl.classList.add('text-red-400');
            }
            
            const getItemTooltipText = (stats) => {
                let tooltip = '';
                for (const stat in stats) {
                    tooltip += `${statAbbreviations[stat]} +${stats[stat]}\n`;
                }
                return tooltip;
            };

            const getItemText = (item) => {
                if (!item) return 'Empty';
                let tooltip = '';
                const implicitMods = getItemTooltipText(item.implicitStats);
                const explicitMods = getItemTooltipText(item.explicitStats);

                if (implicitMods.length > 0) {
                    tooltip += `Implicit Modifiers:\n${implicitMods}`;
                }
                if (explicitMods.length > 0) {
                    tooltip += `Explicit Modifiers:\n${explicitMods}`;
                }
                // Only use the first word of the item's name for display to prevent redundancy.
                const itemName = item.name.split(' ')[0];
                return `<span class="${rarities[item.rarity]} hover:underline cursor-pointer" title="${tooltip.trim()}">${itemName}</span>`;
            };

            helmetSlotEl.innerHTML = `Helmet: ${getItemText(player.equipment.helmet)}`;
            chestSlotEl.innerHTML = `Chest: ${getItemText(player.equipment.chest)}`;
            bootsSlotEl.innerHTML = `Boots: ${getItemText(player.equipment.boots)}`;
            weaponSlotEl.innerHTML = `Weapon: ${getItemText(player.equipment.weapon)}`;
            shieldSlotEl.innerHTML = `Shield: ${getItemText(player.equipment.shield)}`;
        }
        
        function getTooltipText(item) {
            let tooltip = '';
            for (const stat in item.stats) {
                tooltip += `${stat}: +${item.stats[stat]}\n`;
            }
            return tooltip.trim();
        }

        function resetGame() {
            player = {
                name: "Hero",
                strength: 0,
                dexterity: 0,
                recovery: 0,
                intelligence: 0,
                damageReduction: 0, // Added new stat to player
                bonusHealth: 0, // New stat for health bonuses from items
                level: 1,
                xp: 0,
                xpToNextLevel: 10,
                skillPoints: 0,
                isTurn: true,
                spells: spells,
                baseMinDamage: baseMinDamage,
                baseMaxDamage: baseMaxDamage,
                equipment: {
                    helmet: null,
                    chest: null,
                    boots: null,
                    weapon: null,
                    shield: null,
                }
            };
            player.health = baseHealth; // Initializing with base health
            player.maxHealth = baseHealth; // Initializing with base health
            player.maxMana = baseMana + (player.intelligence * 2);
            player.mana = player.maxMana;
            
            // Set the enemy's level to 1 at the start of a new game.
            currentEnemyLevel = 1;
            enemy = createEnemy(currentEnemyLevel);
            
            gameLogEl.innerHTML = '';
            logMessage('<p>Welcome, brave <span class="text-green-500 font-bold">Hero</span>. An <span class="text-red-400 font-bold">Enemy</span> stands in your way!</p>');
            gameOverModal.classList.add('hidden');
            actionButtonsContainer.classList.remove('hidden');
            victoryButtonsContainer.classList.add('hidden');
            player.isTurn = true;
            updateUI();
        }

        function startNextBattle() {
            player.health = player.maxHealth;
            player.mana = player.maxMana;
            
            // The enemy's level no longer increments, but is still passed to createEnemy
            enemy = createEnemy(currentEnemyLevel);

            gameLogEl.innerHTML = '';
            logMessage('<p>A new <span class="text-red-400 font-bold">enemy</span> appears!</p>');
            actionButtonsContainer.classList.remove('hidden');
            victoryButtonsContainer.classList.add('hidden');
            player.isTurn = true;
            updateUI();
            logMessage("The battle begins!");
        }

        function addItemForTesting() {
            // Item generation is now based on the current enemy's level
            const droppedItem = getRandomItem();
            if (droppedItem) {
                logMessage(`You found a new item!`);
                showItemFoundModal(droppedItem);
            }
        }

        // The addRecovery function now only adds to maxHealth, as requested
        function addStrength() {
            if (player.skillPoints > 0) {
                player.strength++;
                player.skillPoints--;
                // Correct calculation for max health
                player.maxHealth = baseHealth + (player.strength * 1) + (player.recovery * 3) + player.bonusHealth;
                player.health = player.maxHealth;
                updateUI();
            }
        }

        function addDexterity() {
            if (player.skillPoints > 0) {
                player.dexterity++;
                player.skillPoints--;
                updateUI();
            }
        }
        
        function addRecovery() {
            if (player.skillPoints > 0) {
                player.recovery++;
                player.skillPoints--;
                // Correct calculation for max health
                player.maxHealth = baseHealth + (player.strength * 1) + (player.recovery * 3) + player.bonusHealth;
                player.health = player.maxHealth;
                updateUI();
            }
        }

        function addIntelligence() {
            if (player.skillPoints > 0) {
                player.intelligence++;
                player.skillPoints--;
                player.maxMana = baseMana + (player.intelligence * 2);
                player.mana = player.maxMana;
                updateUI();
            }
        }

        attackButton.addEventListener('click', () => {
            if (!player.isTurn) return;
            performAttack(player, enemy);
            updateUI();
            if (!checkGameState()) {
                enemyTurn();
            }
        });

        spellsButton.addEventListener('click', showSpellsMenu);
        backButton.addEventListener('click', hideSpellsMenu);

        addStrButton.addEventListener('click', addStrength);
        addDexButton.addEventListener('click', addDexterity);
        addRecButton.addEventListener('click', addRecovery);
        addIntButton.addEventListener('click', addIntelligence);

        nextEnemyButton.addEventListener('click', startNextBattle);
        resetButton.addEventListener('click', resetGame);
        restartButton.addEventListener('click', resetGame);
        addItemButton.addEventListener('click', addItemForTesting);

        window.onload = () => {
            resetGame();
        };
    </script>
</body>
</html>
